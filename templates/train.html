<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trening Modelu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Trening Modelu Klasyfikacji</h1>
        <a href="/" class="back-link">← Powrót do Klasyfikacji</a>

        <div id="train-container">
            <div class="train-form" id="train-form">
                <h2>Konfiguracja Parametrów</h2>
                <p style="color: yellow;">Trening może trwać kilka minut. Nie zamykaj strony!</p>
                <form method="post" novalidate>
                    <label for="model_type">Wybierz model:</label>
                    <select name="model_type" id="model_type" onchange="toggleParams()" class="input-field">
                        <option value="herbert" {% if selected_model == 'herbert' %}selected{% endif %}>HerBERT</option>
                        <option value="bert" {% if selected_model == 'bert' %}selected{% endif %}>BERT</option>
                        <option value="mlp" {% if selected_model == 'mlp' %}selected{% endif %}>MLP</option>
                    </select>
                    
                    <div id="transformer_params">
                        <label for="epochs">Liczba Epok:</label>
                        <input type="number" name="epochs" value="{% if params %}{{ params['epochs'] }}{% else %}{{ defaults.epochs }}{% endif %}" min="1" required>
                        <label for="batch_size">Rozmiar Batcha (trening):</label>
                        <input type="number" name="batch_size" value="{% if params %}{{ params['batch_size'] }}{% else %}{{ defaults.batch_size }}{% endif %}" min="1" required>
                        <label for="lr">Współczynnik Uczenia (LR):</label>
                        <input type="number" step="any" name="lr" value="{% if params %}{{ params['lr'] }}{% else %}{{ defaults.learning_rate }}{% endif %}" required>
                        <label for="max_length">Maksymalna długość sekwencji:</label>
                        <input type="number" name="max_length" value="{% if params %}{{ params['max_length'] }}{% else %}{{ defaults.max_length }}{% endif %}" min="32" required>
                        <label class="checkbox-label" for="early_stopping_transformer">
                            <input type="checkbox" name="early_stopping" id="early_stopping_transformer" {% if params and params.get('early_stopping') or not params and defaults.early_stopping %}checked{% endif %}> Włącz Early Stopping
                        </label>
                        <label for="early_stopping_patience">Early Stopping Patience:</label>
                        <input type="number" name="early_stopping_patience" value="{% if params %}{{ params['early_stopping_patience'] }}{% else %}{{ defaults.early_stopping_patience }}{% endif %}" min="1" required>
                    </div>
                    
                    <div id="mlp_params" style="display: none;">
                        <label for="epochs">Liczba Epok:</label>
                        <input type="number" name="epochs" value="{% if params %}{{ params['epochs'] }}{% else %}{{ defaults.epochs }}{% endif %}" min="1" required>
                        <label for="lr">Współczynnik Uczenia (LR):</label>
                        <input type="number" step="any" name="lr" value="{% if params %}{{ params['lr'] }}{% else %}{{ defaults.learning_rate }}{% endif %}" required>
                        <label for="batch_size">Rozmiar Batcha:</label>
                        <input type="number" name="batch_size" value="{% if params %}{{ params['batch_size'] }}{% else %}{{ defaults.batch_size }}{% endif %}" min="1" required>
                        <label for="max_features">Maks. Liczba Cech (TF-IDF):</label>
                        <input type="number" name="max_features" value="{% if params %}{{ params['max_features'] }}{% else %}{{ defaults.max_features }}{% endif %}" min="100" required>
                        <label for="hidden_size">Rozmiar Warstwy Ukrytej:</label>
                        <input type="number" name="hidden_size" value="{% if params %}{{ params['hidden_size'] }}{% else %}{{ defaults.hidden_size }}{% endif %}" min="10" required>
                        <label for="num_layers">Liczba Warstw Ukrytych:</label>
                        <input type="number" name="num_layers" value="{% if params %}{{ params['num_layers'] }}{% else %}{{ defaults.num_layers }}{% endif %}" min="1" required>
                        <label for="dropout">Współczynnik Dropout:</label>
                        <input type="number" step="0.01" name="dropout" value="{% if params %}{{ params['dropout'] }}{% else %}{{ defaults.dropout }}{% endif %}" min="0" max="1" required>
                        <label class="checkbox-label" for="early_stopping_mlp">
                            <input type="checkbox" name="early_stopping" id="early_stopping_mlp" {% if params and params.get('early_stopping') or not params and defaults.early_stopping %}checked{% endif %}> Włącz Early Stopping
                        </label>
                        <label for="early_stopping_patience">Early Stopping Patience:</label>
                        <input type="number" name="early_stopping_patience" value="{% if params %}{{ params['early_stopping_patience'] }}{% else %}{{ defaults.early_stopping_patience }}{% endif %}" min="1" required>
                    </div>
                    
                    <button type="submit">Rozpocznij Trening</button>
                </form>
            </div>

            <div id="training-panel" style="display:none; margin-top:20px;">
                <h2>Trening w toku...</h2>
                <p id="training-msg">Rozpoczynam trening...</p>
                <div class="progress-bar-container">
                    <div id="training-bar" class="progress-bar"></div>
                </div>
                <p>Epoka: <span id="training-epoch">0</span>/<span id="training-epochs">0</span> — Loss: <span id="training-loss">-</span> — Accuracy: <span id="training-acc">-</span></p>
                <p id="training-error" style="color:red; display:none;"></p>
                <div class="history" id="training-logs">
                    <h4>Logi Treningu</h4>
                    <ul id="log-list"></ul>
                </div>
            </div>
        </div>

        <div class="results" id="results-div" style="display:none;">
            <h2>Wyniki Treningu</h2>
            <p><strong>Parametry:</strong> Epoki: <span id="res-epochs"></span>, LR: <span id="res-lr"></span>, Batch: <span id="res-batch"></span></p>
            <p><strong>Ostateczna Dokładność:</strong> <span id="res-acc"></span></p>
            <p><strong>Model:</strong> <span id="res-model"></span> — <strong>Data treningu:</strong> <span id="res-date"></span></p>
            <p id="res-note" style="color:orange;"></p>
            <h3>Wykres Straty (Loss)</h3>
            <img id="res-loss-plot" src="" alt="Loss Plot">
            <h3>Wykres Dokładności</h3>
            <img id="res-acc-plot" src="" alt="Accuracy Plot">
            <div class="history">
                <h3>Historia Epok</h3>
                <ul id="res-history"></ul>
            </div>
        </div>
    </div>

    <script>
        // Defaults for both model groups come from server (transformer_defaults, mlp_defaults)
        const defaultValues = {
            herbert: {
                epochs: {{ transformer_defaults.epochs }},
                batch_size: {{ transformer_defaults.batch_size }},
                lr: {{ transformer_defaults.learning_rate }},
                max_length: {{ transformer_defaults.max_length }},
                early_stopping_patience: {{ transformer_defaults.early_stopping_patience }},
                early_stopping: {{ 'true' if transformer_defaults.early_stopping else 'false' }},
            },
            bert: {
                epochs: {{ transformer_defaults.epochs }},
                batch_size: {{ transformer_defaults.batch_size }},
                lr: {{ transformer_defaults.learning_rate }},
                max_length: {{ transformer_defaults.max_length }},
                early_stopping_patience: {{ transformer_defaults.early_stopping_patience }},
                early_stopping: {{ 'true' if transformer_defaults.early_stopping else 'false' }},
            },
            mlp: {
                epochs: {{ mlp_defaults.epochs }},
                batch_size: {{ mlp_defaults.batch_size }},
                lr: {{ mlp_defaults.learning_rate }},
                max_features: {{ mlp_defaults.max_features }},
                hidden_size: {{ mlp_defaults.hidden_size }},
                num_layers: {{ mlp_defaults.num_layers }},
                dropout: {{ mlp_defaults.dropout }},
                early_stopping_patience: {{ mlp_defaults.early_stopping_patience }},
                early_stopping: {{ 'true' if mlp_defaults.early_stopping else 'false' }},
            },
        };

        function toggleParams() {
            const modelType = document.getElementById('model_type').value;
            const transformerParams = document.getElementById('transformer_params');
            const mlpParams = document.getElementById('mlp_params');
            
            if (modelType === 'herbert' || modelType === 'bert') {
                transformerParams.style.display = 'block';
                mlpParams.style.display = 'none';
                // populate transformer inputs with defaults when switching
                transformerParams.querySelector('input[name="epochs"]').value = defaultValues[modelType].epochs;
                transformerParams.querySelector('input[name="batch_size"]').value = defaultValues[modelType].batch_size;
                transformerParams.querySelector('input[name="lr"]').value = defaultValues[modelType].lr;
                transformerParams.querySelector('input[name="max_length"]').value = defaultValues[modelType].max_length;
                transformerParams.querySelector('input[name="early_stopping_patience"]').value = defaultValues[modelType].early_stopping_patience;
                document.getElementById('early_stopping_transformer').checked = defaultValues[modelType].early_stopping === true || defaultValues[modelType].early_stopping === 'true';
            } else {
                transformerParams.style.display = 'none';
                mlpParams.style.display = 'block';
                // populate mlp inputs with defaults when switching
                mlpParams.querySelector('input[name="epochs"]').value = defaultValues.mlp.epochs;
                mlpParams.querySelector('input[name="lr"]').value = defaultValues.mlp.lr;
                mlpParams.querySelector('input[name="batch_size"]').value = defaultValues.mlp.batch_size;
                mlpParams.querySelector('input[name="max_features"]').value = defaultValues.mlp.max_features;
                mlpParams.querySelector('input[name="hidden_size"]').value = defaultValues.mlp.hidden_size;
                mlpParams.querySelector('input[name="num_layers"]').value = defaultValues.mlp.num_layers;
                mlpParams.querySelector('input[name="dropout"]').value = defaultValues.mlp.dropout;
                mlpParams.querySelector('input[name="early_stopping_patience"]').value = defaultValues.mlp.early_stopping_patience;
                document.getElementById('early_stopping_mlp').checked = defaultValues.mlp.early_stopping === true || defaultValues.mlp.early_stopping === 'true';
            }
        }

        let lastEpoch = 0;
        function pollTraining() {
            fetch('/training_status')
                .then(r => r.json())
                .then(s => {
                    const form = document.querySelector('form');
                    const trainingPanel = document.getElementById('training-panel');
                    const errorEl = document.getElementById('training-error');

                    if (!s || (!s.running && !s.completed && !s.error)) {
                         form.style.display = 'block';
                         trainingPanel.style.display = 'none';
                         return;
                    }

                    form.style.display = 'none';
                    trainingPanel.style.display = 'block';

                    if (s.running) {
                        document.getElementById('training-msg').innerText = s.message || 'Training...';
                        document.getElementById('training-epoch').innerText = s.epoch || 0;
                        document.getElementById('training-epochs').innerText = s.epochs || 0;
                        document.getElementById('training-loss').innerText = s.loss ? s.loss.toFixed(4) : '-';
                        document.getElementById('training-acc').innerText = s.accuracy ? (s.accuracy * 100).toFixed(2) + '%' : '-';
                        document.getElementById('training-bar').style.width = (s.progress || 0) + '%';
                        
                        if (s.epoch && s.epoch > lastEpoch) {
                            // Only append epochs that have a finite accuracy value
                            const acc = s.accuracy;
                            const loss = s.loss;
                            if (Number.isFinite(acc)) {
                                const li = document.createElement('li');
                                li.innerText = `Epoka ${s.epoch}: Loss = ${Number.isFinite(loss) ? loss.toFixed(4) : '-'}, Accuracy = ${(acc * 100).toFixed(2)}%`;
                                document.getElementById('log-list').appendChild(li);
                                lastEpoch = s.epoch;
                            }
                        }
                        setTimeout(pollTraining, 1500);

                    } else if (s.error) {
                        errorEl.style.display = 'block';
                        errorEl.innerText = 'Błąd: ' + s.error;
                        document.getElementById('training-msg').innerText = 'Trening zakończony błędem';
                    
                    } else if (s.completed) {
                        fetch('/training_result').then(r => r.json()).then(data => {
                            if (data.ready) {
                                trainingPanel.style.display = 'none';
                                const resultsDiv = document.getElementById('results-div');
                                resultsDiv.style.display = 'block';

                                document.getElementById('res-epochs').innerText = data.params.epochs;
                                document.getElementById('res-lr').innerText = data.params.lr;
                                document.getElementById('res-batch').innerText = data.params.batch_size;

                                // show model and completed date
                                document.getElementById('res-model').innerText = data.model_type || 'N/A';
                                if (data.completed_at) {
                                    const d = new Date(data.completed_at);
                                    document.getElementById('res-date').innerText = d.toLocaleString('pl-PL');
                                } else {
                                    document.getElementById('res-date').innerText = 'N/A';
                                }

                                // warn if results are for different model than currently selected
                                const currentModel = document.getElementById('model_type') ? document.getElementById('model_type').value : null;
                                const noteEl = document.getElementById('res-note');
                                if (data.model_type && currentModel && data.model_type !== currentModel) {
                                    noteEl.innerText = `Uwaga: wyniki dotyczą modelu ${data.model_type}`;
                                } else {
                                    noteEl.innerText = '';
                                }

                                // Pick the last finite accuracy as the final accuracy
                                const validAccs = (data.accuracies || []).filter(a => Number.isFinite(a));
                                const finalAcc = validAccs.length ? validAccs[validAccs.length - 1] : null;
                                document.getElementById('res-acc').innerText = finalAcc !== null ? (finalAcc * 100).toFixed(2) + '%' : 'N/A';
                                
                                // Set plots only if available
                                if (data.plot_loss) {
                                    document.getElementById('res-loss-plot').src = 'data:image/png;base64,' + data.plot_loss;
                                    document.getElementById('res-loss-plot').style.display = 'block';
                                } else {
                                    document.getElementById('res-loss-plot').style.display = 'none';
                                }
                                if (data.plot_acc) {
                                    document.getElementById('res-acc-plot').src = 'data:image/png;base64,' + data.plot_acc;
                                    document.getElementById('res-acc-plot').style.display = 'block';
                                } else {
                                    document.getElementById('res-acc-plot').style.display = 'none';
                                }
                                
                                const historyUl = document.getElementById('res-history');
                                historyUl.innerHTML = (data.losses || []).map((loss, i) => {
                                    const acc = data.accuracies && data.accuracies[i];
                                    if (!Number.isFinite(acc)) return '';
                                    return `<li>Epoka ${i + 1}: Loss = ${Number.isFinite(loss) ? loss.toFixed(4) : '-'}, Accuracy = ${(acc * 100).toFixed(2)}%</li>`;
                                }).filter(Boolean).join('');
                            }
                        });
                    }
                })
                .catch(() => setTimeout(pollTraining, 3000));
        }

        document.addEventListener('DOMContentLoaded', function() {
            toggleParams();
            {% if training or status and (status.running or status.completed) %}
                const form = document.querySelector('form');
                form.style.display = 'none';
                document.getElementById('training-panel').style.display = 'block';
                document.getElementById('log-list').innerHTML = '';
                 {% if params is defined and params %}
                    document.getElementById('training-epochs').innerText = {% if params and 'epochs' in params %}{{ params['epochs'] }}{% else %}{{ defaults.epochs }}{% endif %};
                {% elif status is defined and status %}
                    document.getElementById('training-epochs').innerText = {{ status['epochs'] }};
                {% endif %}
                // reset the in-memory epoch counter and logs for this session
                lastEpoch = 0;
                document.getElementById('log-list').innerHTML = '';
            {% endif %}
            
            pollTraining();
        });
    </script>
</body>
</html>